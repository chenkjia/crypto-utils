const Web3 = require("web3");
const axios = require("axios");
const CALLDATA = "000000000000000000000000000000000000000000000000000000006337b6470000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000000100000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000104472b43f3000000000000000000000000000000000000000000000001272e384e848f00000000000000000000000000000000000000000000000001527e6370787b20d2660000000000000000000000000000000000000000000000000000000000000080000000000000000000000000c89ce9f096ddb405359b22a4863a08e8828e88d700000000000000000000000000000000000000000000000000000000000000030000000000000000000000001e4ede388cbc9f4b5c79681b7f94d36a11abebc9000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2000000000000000000000000d2877702675e6ceb975b4a1dff9fb7baf4c91ea900000000000000000000000000000000000000000000000000000000";
// const CALLDATA = "0x5ae401dc000000000000000000000000000000000000000000000000000000006332ee6b000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000016000000000000000000000000000000000000000000000000000000000000000e4472b43f3000000000000000000000000000000000000000000000a96ec7ff33fad2d29dd0000000000000000000000000000000000000000000000002f760b1f4cb3618a0000000000000000000000000000000000000000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000020000000000000000000000001e4ede388cbc9f4b5c79681b7f94d36a11abebc9000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004449404b7c0000000000000000000000000000000000000000000000002f760b1f4cb3618a000000000000000000000000adcd5710c6b58ca84fa15176f57cce951829bd1900000000000000000000000000000000000000000000000000000000";
// const CALLDATA = "0000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000040000000000000000000000000000000000000000000000000000000000000008413ead5620000000000000000000000005c8cd1c2f2997f7a041026cc29de8177b4c6d8ec00000000000000000000000089e54f174ca5ff39cf53ab58004158e2ca012eac0000000000000000000000000000000000000000000000000000000000000bb8000000000000000000000000000000000035f2482336c0d4c2ba6e94faa1d66f000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000164883164560000000000000000000000005c8cd1c2f2997f7a041026cc29de8177b4c6d8ec00000000000000000000000089e54f174ca5ff39cf53ab58004158e2ca012eac0000000000000000000000000000000000000000000000000000000000000bb8fffffffffffffffffffffffffffffffffffffffffffffffffffffffffff2764c00000000000000000000000000000000000000000000000000000000000a11a8000000000000000000000000000000000000000000000000000000e8d4a510000000000000000000000000000000000000000000000a56d35c029fd16645e079000000000000000000000000000000000000000000000000000000e840308c030000000000000000000000000000000000000000000a503344abc0fbe23670910000000000000000000000005a2b5cb4ce921abd65f0c66c2c839894bfc2076c000000000000000000000000000000000000000000000000000000006244356a00000000000000000000000000000000000000000000000000000000"
const web3 = new Web3();

const extractParameters = (signature) => {
    let params = [];

    const allParameters = /\b[^()]+\((.*)\)$/gm;
    const splitParameters = /((\(.+?\))|([^,() ]+)){1}/gm;

    let _allParameters = allParameters.exec(signature)[1];

    while ((match = splitParameters.exec(_allParameters))) {
        params.push(match[0]);
    }

    return params;
}

async function decode(calldata) {
    let calls = web3.eth.abi.decodeParameters(['uint256', 'bytes[]'], calldata)[1];
    for (let index = 0; index < calls.length; index++) {
        console.log(calls[index])
        let call = calls[index].replace("0x", "");
        let selector = call.slice(0, 8);
        let data = call.slice(8);
        console.log(selector)
        console.log(data)
        console.log('-------------------------------')
        let request = await axios.get(
            `https://www.4byte.directory/api/v1/signatures/?hex_signature=${selector}`
        );
        let signature = request.data.results[0].text_signature;
        console.log(`步骤 ${index}, 方法: ${signature}`);

        let parameters = extractParameters(signature);
        console.log(parameters)
        let decoded = web3.eth.abi.decodeParameters(parameters, data);

        for (let i = 0; i < parameters.length; i++) {
            console.log(`   参数 ${i} - 类型: ${parameters[i]} - 值: ${decoded[i]}`);
        }
    }
}

const a = decode(CALLDATA);